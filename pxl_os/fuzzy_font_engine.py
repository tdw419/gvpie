import torch

# Constants from gvpie-bootstrap/src/glyph_bootstrap.rs
FIRST_PRINTABLE = 32
LAST_PRINTABLE = 126
GLYPH_WIDTH = 5
GLYPH_HEIGHT = 7

# Translated from gvpie-bootstrap/src/glyph_rom.rs
# Each glyph row stores five pixels in the lowest bits (bit 0 = leftmost pixel).
GLYPH_ROM = [
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],  # 32 ' '
    [0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0x00],  # 33 '!'
    [0x0A, 0x0A, 0x04, 0x00, 0x00, 0x00, 0x00],  # 34 '"'
    [0x0A, 0x0A, 0x1F, 0x0A, 0x1F, 0x0A, 0x0A],  # 35 '#'
    [0x04, 0x1F, 0x05, 0x0E, 0x14, 0x0F, 0x04],  # 36 '$'
    [0x18, 0x19, 0x02, 0x04, 0x08, 0x13, 0x03],  # 37 '%'
    [0x04, 0x0A, 0x04, 0x16, 0x09, 0x09, 0x16],  # 38 '&'
    [0x02, 0x02, 0x04, 0x00, 0x00, 0x00, 0x00],  # 39 '''
    [0x02, 0x04, 0x08, 0x08, 0x08, 0x04, 0x02],  # 40 '('
    [0x08, 0x04, 0x02, 0x02, 0x02, 0x04, 0x08],  # 41 ')'
    [0x00, 0x04, 0x15, 0x0E, 0x15, 0x04, 0x00],  # 42 '*'
    [0x00, 0x04, 0x04, 0x1F, 0x04, 0x04, 0x00],  # 43 '+'
    [0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x08],  # 44 ','
    [0x00, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x00],  # 45 '-'
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x06],  # 46 '.'
    [0x01, 0x02, 0x04, 0x08, 0x10, 0x00, 0x00],  # 47 '/'
    [0x0E, 0x11, 0x13, 0x15, 0x19, 0x11, 0x0E],  # 48 '0'
    [0x04, 0x0C, 0x04, 0x04, 0x04, 0x04, 0x0E],  # 49 '1'
    [0x0E, 0x11, 0x01, 0x02, 0x04, 0x08, 0x1F],  # 50 '2'
    [0x1F, 0x02, 0x04, 0x02, 0x01, 0x11, 0x0E],  # 51 '3'
    [0x02, 0x06, 0x0A, 0x12, 0x1F, 0x02, 0x02],  # 52 '4'
    [0x1F, 0x10, 0x1E, 0x01, 0x01, 0x11, 0x0E],  # 53 '5'
    [0x06, 0x08, 0x10, 0x1E, 0x11, 0x11, 0x0E],  # 54 '6'
    [0x1F, 0x01, 0x02, 0x04, 0x08, 0x08, 0x08],  # 55 '7'
    [0x0E, 0x11, 0x11, 0x0E, 0x11, 0x11, 0x0E],  # 56 '8'
    [0x0E, 0x11, 0x11, 0x0F, 0x01, 0x02, 0x0C],  # 57 '9'
    [0x00, 0x06, 0x06, 0x00, 0x06, 0x06, 0x00],  # 58 ':'
    [0x00, 0x06, 0x06, 0x00, 0x06, 0x06, 0x0C],  # 59 ';'
    [0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02],  # 60 '<'
    [0x00, 0x00, 0x1F, 0x00, 0x1F, 0x00, 0x00],  # 61 '='
    [0x08, 0x04, 0x02, 0x01, 0x02, 0x04, 0x08],  # 62 '>'
    [0x0E, 0x11, 0x01, 0x02, 0x04, 0x00, 0x04],  # 63 '?'
    [0x0E, 0x11, 0x17, 0x15, 0x17, 0x10, 0x0F],  # 64 '@'
    [0x0E, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11],  # 65 'A'
    [0x1E, 0x11, 0x11, 0x1E, 0x11, 0x11, 0x1E],  # 66 'B'
    [0x0E, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0E],  # 67 'C'
    [0x1C, 0x12, 0x11, 0x11, 0x11, 0x12, 0x1C],  # 68 'D'
    [0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x1F],  # 69 'E'
    [0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x10],  # 70 'F'
    [0x0E, 0x11, 0x10, 0x17, 0x11, 0x11, 0x0E],  # 71 'G'
    [0x11, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11],  # 72 'H'
    [0x0E, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0E],  # 73 'I'
    [0x01, 0x01, 0x01, 0x01, 0x11, 0x11, 0x0E],  # 74 'J'
    [0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11],  # 75 'K'
    [0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1F],  # 76 'L'
    [0x11, 0x1B, 0x15, 0x15, 0x11, 0x11, 0x11],  # 77 'M'
    [0x11, 0x19, 0x15, 0x13, 0x11, 0x11, 0x11],  # 78 'N'
    [0x0E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E],  # 79 'O'
    [0x1E, 0x11, 0x11, 0x1E, 0x10, 0x10, 0x10],  # 80 'P'
    [0x0E, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0D],  # 81 'Q'
    [0x1E, 0x11, 0x11, 0x1E, 0x14, 0x12, 0x11],  # 82 'R'
    [0x0E, 0x11, 0x10, 0x0E, 0x01, 0x11, 0x0E],  # 83 'S'
    [0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04],  # 84 'T'
    [0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E],  # 85 'U'
    [0x11, 0x11, 0x11, 0x11, 0x0A, 0x0A, 0x04],  # 86 'V'
    [0x11, 0x11, 0x11, 0x15, 0x15, 0x1B, 0x11],  # 87 'W'
    [0x11, 0x11, 0x0A, 0x04, 0x0A, 0x11, 0x11],  # 88 'X'
    [0x11, 0x11, 0x0A, 0x04, 0x04, 0x04, 0x04],  # 89 'Y'
    [0x1F, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1F],  # 90 'Z'
    [0x06, 0x04, 0x04, 0x04, 0x04, 0x04, 0x06],  # 91 '['
    [0x10, 0x08, 0x04, 0x02, 0x01, 0x00, 0x00],  # 92 '\'
    [0x0C, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0C],  # 93 ']'
    [0x04, 0x0A, 0x11, 0x00, 0x00, 0x00, 0x00],  # 94 '^'
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F],  # 95 '_'
    [0x04, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00],  # 96 '`'
    [0x00, 0x00, 0x0E, 0x01, 0x0F, 0x11, 0x0F],  # 97 'a'
    [0x10, 0x10, 0x1E, 0x11, 0x11, 0x11, 0x1E],  # 98 'b'
    [0x00, 0x00, 0x0E, 0x10, 0x10, 0x11, 0x0E],  # 99 'c'
    [0x01, 0x01, 0x0F, 0x11, 0x11, 0x11, 0x0F],  # 100 'd'
    [0x00, 0x00, 0x0E, 0x11, 0x1F, 0x10, 0x0E],  # 101 'e'
    [0x02, 0x04, 0x0E, 0x04, 0x04, 0x04, 0x04],  # 102 'f'
    [0x00, 0x0F, 0x11, 0x11, 0x0F, 0x01, 0x0E],  # 103 'g'
    [0x10, 0x10, 0x1E, 0x11, 0x11, 0x11, 0x11],  # 104 'h'
    [0x04, 0x00, 0x04, 0x04, 0x04, 0x04, 0x04],  # 105 'i'
    [0x02, 0x00, 0x02, 0x02, 0x02, 0x12, 0x0C],  # 106 'j'
    [0x10, 0x10, 0x12, 0x14, 0x18, 0x14, 0x12],  # 107 'k'
    [0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04],  # 108 'l'
    [0x00, 0x00, 0x1A, 0x15, 0x15, 0x15, 0x15],  # 109 'm'
    [0x00, 0x00, 0x1A, 0x15, 0x11, 0x11, 0x11],  # 110 'n'
    [0x00, 0x00, 0x0E, 0x11, 0x11, 0x11, 0x0E],  # 111 'o'
    [0x00, 0x1E, 0x11, 0x11, 0x1E, 0x10, 0x10],  # 112 'p'
    [0x00, 0x0F, 0x11, 0x11, 0x0F, 0x01, 0x01],  # 113 'q'
    [0x00, 0x00, 0x1A, 0x15, 0x10, 0x10, 0x10],  # 114 'r'
    [0x00, 0x00, 0x0F, 0x10, 0x0E, 0x01, 0x1E],  # 115 's'
    [0x04, 0x04, 0x1F, 0x04, 0x04, 0x04, 0x02],  # 116 't'
    [0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0D],  # 117 'u'
    [0x00, 0x00, 0x11, 0x11, 0x11, 0x0A, 0x04],  # 118 'v'
    [0x00, 0x00, 0x11, 0x15, 0x15, 0x15, 0x0A],  # 119 'w'
    [0x00, 0x00, 0x11, 0x0A, 0x04, 0x0A, 0x11],  # 120 'x'
    [0x00, 0x11, 0x11, 0x11, 0x0F, 0x01, 0x0E],  # 121 'y'
    [0x00, 0x00, 0x1F, 0x02, 0x04, 0x08, 0x1F],  # 122 'z'
    [0x02, 0x04, 0x04, 0x08, 0x04, 0x04, 0x02],  # 123 '{'
    [0x04, 0x04, 0x04, 0x00, 0x04, 0x04, 0x04],  # 124 '|'
    [0x08, 0x04, 0x04, 0x02, 0x04, 0x04, 0x08],  # 125 '}'
    [0x00, 0x00, 0x08, 0x15, 0x02, 0x00, 0x00],  # 126 '~'
]

def _init_char_to_pixels():
    """Converts the GLYPH_ROM into a more usable dictionary."""
    char_to_pixels = {}
    for i, glyph_rows in enumerate(GLYPH_ROM):
        char_code = FIRST_PRINTABLE + i
        pixels = torch.zeros((GLYPH_HEIGHT, GLYPH_WIDTH), dtype=torch.uint8)
        for row_idx, row_bits in enumerate(glyph_rows):
            for col_idx in range(GLYPH_WIDTH):
                if (row_bits >> col_idx) & 1:
                    pixels[row_idx, col_idx] = 1
        char_to_pixels[chr(char_code)] = pixels
    return char_to_pixels

CHAR_TO_PIXELS = _init_char_to_pixels()


class FuzzyFontEngine:
    """Bidirectional text to pixels with error tolerance."""

    def render_text(self, canvas, x, y, text, color=(255, 255, 255)):
        """Renders text onto a canvas."""
        cursor_x = x
        for char in text:
            if char in CHAR_TO_PIXELS:
                glyph = CHAR_TO_PIXELS[char]
                for row_idx, row in enumerate(glyph):
                    for col_idx, pixel in enumerate(row):
                        if pixel:
                            canvas[y + row_idx, cursor_x + col_idx] = torch.tensor(color, dtype=torch.uint8)
                cursor_x += GLYPH_WIDTH + 1  # Add 1 for spacing

    def recognize_text(self, canvas, x, y, max_chars):
        """Recognizes text from a canvas with confidence scores."""
        # This is a complex task and will be implemented later.
        raise NotImplementedError

    def encode_machine_code(self, text: str) -> torch.Tensor:
        """Convert text to GVPIE machine texture format."""
        canvas = torch.zeros((len(text), 3), dtype=torch.uint8)
        for i, ch in enumerate(text):
            if FIRST_PRINTABLE <= ord(ch) <= LAST_PRINTABLE:
                canvas[i, 0] = ord(ch)  # R = ASCII code
                canvas[i, 1] = 0        # G = 0
                canvas[i, 2] = 0        # B = 0
        return canvas

    def decode_machine_code(self, canvas: torch.Tensor) -> str:
        """Convert GVPIE machine texture to text."""
        chars = canvas[:, 0].cpu().numpy()  # Extract red channel
        return ''.join(chr(c) for c in chars if c > 0)
